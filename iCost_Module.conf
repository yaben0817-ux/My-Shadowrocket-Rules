#!name=iCost AI 服务监控模块（修正版：并发计时+生成记录准确）
#!desc=监控主流AI大模型API请求耗时/模型/Token，并准确解析本次生成记录(results.length)。支持历史统计。log_level=info|debug

[MITM]
hostname = %APPEND% api.deepseek.com, api.siliconflow.cn, ark.cn-beijing.volces.com, openrouter.ai, api.moonshot.cn, generativelanguage.googleapis.com

[Script]
# 请求阶段：记录开始时间 & model（按 $request.id 隔离，避免并发串台）
iCost_Request_Timer = type=http-request, pattern=^https?://(api\.deepseek\.com/chat/completions|api\.siliconflow\.cn/v1/chat/completions|ark\.cn-beijing\.volces\.com/api/v3/chat/completions|openrouter\.ai/api/v1/chat/completions|api\.moonshot\.cn/v1/chat/completions|generativelanguage\.googleapis\.com/v1beta/openai/chat/completions), requires-body=true, max-size=3145728, script-path=https://raw.githubusercontent.com/yaben0817-ux/My-Shadowrocket-Rules/refs/heads/main/iCost_Stats.js, timeout=30, argument=phase=request&log_level=info

# 响应阶段：计算耗时、解析本次生成记录(results.length)、token、并写入历史统计
iCost_Response_Monitor = type=http-response, pattern=^https?://(api\.deepseek\.com/chat/completions|api\.siliconflow\.cn/v1/chat/completions|ark\.cn-beijing\.volces\.com/api/v3/chat/completions|openrouter\.ai/api/v1/chat/completions|api\.moonshot\.cn/v1/chat/completions|generativelanguage\.googleapis\.com/v1beta/openai/chat/completions), requires-body=true, max-size=3145728, script-path=https://raw.githubusercontent.com/yaben0817-ux/My-Shadowrocket-Rules/refs/heads/main/iCost_Stats.js, timeout=30, argument=phase=response&log_level=info
